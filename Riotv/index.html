<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlayTorrio IPTV</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L6XEJK6GGJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-L6XEJK6GGJ');
  </script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "typmqsezbv");
    </script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <link rel="icon" type="image/x-icon" href="logo.ico">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent-primary: #00ffff; /* Cyan - Default */
            --accent-secondary: #ff00ff; /* Magenta */
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 255, 255, 0.3);
            --highlight-bg: rgba(0, 255, 255, 0.1);
            --accent-primary-rgb: 0, 255, 255;
            --accent-secondary-rgb: 255, 0, 255;
            --favorite-color: #ffd700;
            --record-color: #dc3545;
        }
        
        body.light-theme {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-primary: #007bff; /* Blue */
            --accent-secondary: #6f42c1; /* Purple */
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 123, 255, 0.2);
            --highlight-bg: rgba(0, 123, 255, 0.1);
            --accent-primary-rgb: 0, 123, 255;
            --accent-secondary-rgb: 111, 66, 193;
            --favorite-color: #ffc107;
            --record-color: #dc3545;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.4s, color 0.4s;
            font-size: 14px;
            overflow: hidden;
        }

        /* Target-like background and layout */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(75, 0, 130, 0.25) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(48, 25, 52, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(75, 0, 130, 0.15) 0%, transparent 50%);
            animation: float 6s ease-in-out infinite alternate;
            pointer-events: none; z-index: -1;
        }
        @keyframes float { 0% { transform: translateY(0) rotate(0); opacity: .7; } 100% { transform: translateY(-20px) rotate(1deg); opacity: .9; } }

        /* Hide old top nav and side menu for this style */
        nav, #sideMenu, #menuOverlay { display: none !important; }

        /* Left countries panel */
        #left {
            width: 35%;
            background: linear-gradient(135deg, rgba(75, 0, 130, 0.95), rgba(48, 25, 52, 0.95));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(75, 0, 130, 0.4);
            border-radius: 0 20px 20px 0;
            box-shadow: 0 0 30px rgba(75, 0, 130, 0.3);
            position: absolute; top: 0; left: 0; height: 100vh; z-index: 10;
            overflow: hidden;
        }
        #left h3 {
            color: #fff; text-align: center; margin: 0; padding: 20px 0; font-size: 1.3rem; font-weight: 700;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #countrySearch {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(75, 0, 130, 0.4);
            border-radius: 25px; color: #fff; padding: 10px 16px; margin: 12px 16px; width: calc(100% - 64px);
            font-size: 14px; outline: none; transition: all .2s ease;
        }
        #countrySearch::placeholder { color: rgba(255,255,255,.75); }
        #countrySearch:focus { border-color: #6A0DAD; background: rgba(255,255,255,.15); box-shadow: 0 0 12px rgba(106,13,173,.35); }
        #menu { overflow-y: auto; height: calc(100vh - 150px); padding: 0; margin: 0; }
    /* More visible scrollbar for the left list */
    #menu::-webkit-scrollbar { width: 10px; }
    #menu::-webkit-scrollbar-track { background: rgba(var(--accent-primary-rgb, 0, 255, 255), 0.18); border-radius: 8px; }
    #menu::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; border: 2px solid transparent; background-clip: padding-box; }
    #menu::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
        #menu li { list-style: none; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,.08); background: #4B0082; min-height: 48px; transition: all .2s ease; }
        #menu li:hover { background: linear-gradient(90deg, rgba(106,13,173,.4), rgba(75,0,130,.3)); transform: translateX(6px); }
        #menu li a { color: #fff; text-decoration: none; display: block; padding: 14px 20px; font-weight: 600; font-size: 14px; }

        /* Right content */
        #right {
            width: 65%; height: 100vh; position: absolute; right: 0; top: 0; overflow: hidden auto;
            background: linear-gradient(135deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
            backdrop-filter: blur(10px);
        }
        #right .content-area { max-width: 900px; margin: 0 auto; padding: 28px 16px; text-align: center; }
    /* Push the welcome block toward the middle without affecting layout when hidden */
    .welcome-section { margin-top: 18vh; }
    .welcome-section h2 { color: #fff; font-size: 2.2rem; margin-bottom: 8px; font-weight: 800; }
        .welcome-section p { color: rgba(255,255,255,.9); font-size: 1rem; margin-bottom: 24px; }
        .stats { display: flex; justify-content: center; gap: 24px; }
        .stat-item { padding: 16px 20px; border-radius: 12px; border: 2px solid rgba(75,0,130,.35); background: linear-gradient(135deg, rgba(75,0,130,.25), rgba(48,25,52,.25)); }
        .stat-number { display: block; color: #fff; font-size: 1.6rem; font-weight: 800; }
        .stat-label { display: block; color: rgba(255,255,255,.85); font-size: .85rem; }

        /* Put our existing main content inside right */
        #appMain { max-width: 1100px; margin: 0 auto; padding: 0 16px 32px; }

        /* Responsive */
        @media (max-width: 768px) {
            #left { width: 100%; border-radius: 0; position: relative; height: auto; }
            #right { width: 100%; position: relative; height: auto; }
            body { overflow: auto; }
            .welcome-section { margin-top: 12vh; }
        }

        .glass-effect {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.4s ease;
        }
        
        body:not(.light-theme) .glass-effect {
             background-color: rgba(26, 26, 26, 0.7);
             backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        
        body.light-theme .glass-effect {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .channel-card, .recording-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }
        .channel-card:hover, .recording-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 0 25px var(--shadow-color), 0 0 10px var(--shadow-color);
            border-color: var(--accent-primary);
        }
        
        body.light-theme .channel-card:hover, body.light-theme .recording-card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(var(--accent-primary-rgb, 0, 255, 255), 0.18); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 8px; border: 2px solid transparent; background-clip: padding-box; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

    /* Global scrollbar styling for better visibility (WebKit & Firefox) */
    html, body { scrollbar-width: thin; scrollbar-color: var(--accent-primary) transparent; }
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.08); }
    body.light-theme *::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.08); }
    *::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 8px; }
    *::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

        .modal-animation { animation: modalFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .filter-btn.active, #audioOnlyBtn.active {
            background-color: var(--highlight-bg);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .neon-button:hover:not(:disabled) {
            background-color: var(--highlight-bg);
            box-shadow: 0 0 15px var(--shadow-color), 0 0 25px var(--shadow-color);
        }
        
        #sideMenu { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #sideMenu.open { transform: translateX(0); }
        #menuOverlay { transition: opacity 0.4s ease; }
        #menuOverlay.open { opacity: 1; pointer-events: auto; }

        .favorite-star {
            position: absolute; top: 8px; left: 8px; cursor: pointer; font-size: 1.25rem;
            color: var(--text-secondary); transition: color 0.2s, transform 0.2s;
        }
        .favorite-star:hover { transform: scale(1.2); }
        .favorite-star.favorited { color: var(--favorite-color); text-shadow: 0 0 8px var(--favorite-color); }
        
        .skeleton-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--bg-secondary); color: var(--text-primary);
            padding: 12px 24px; border-radius: 8px; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { top: 20px; }
        #toast.success { border-left: 4px solid #28a745; }
        #toast.error { border-left: 4px solid #dc3545; }
        #toast .icon { font-size: 1.2rem; }

        .color-swatch {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .color-swatch.active { border-color: var(--text-primary); transform: scale(1.2); }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #install-tooltip-container:hover #install-tooltip {
            opacity: 1; visibility: visible; pointer-events: auto;
        }
        
        #recordBtn {
            color: var(--record-color);
            border-color: var(--record-color);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        #recordBtn.recording {
            animation: pulse-record 1.5s infinite;
        }
        @keyframes pulse-record {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 10px 15px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        #playerContainer.audio-mode::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f001"; /* fa-music */
            font-size: 6rem;
            color: var(--text-secondary);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.3;
            z-index: 0;
        }
        #playerContainer.audio-mode video {
            visibility: hidden;
        }

        .player-select {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 1.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em;
        }

        /* App promo modal enhancements */
        #appPromoModal { z-index: 99999; }
        #appPromoModal .glass-effect {
            border: 1.5px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.35), 0 0 30px var(--shadow-color);
        }
        #appPromoModal .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 0;
        }
        #appPromoModal .feature-item i { color: var(--accent-primary); }
        #appPromoModal .feature-item span { color: var(--text-secondary); }
        @media (max-width: 768px) {
            #appPromoModal .glass-effect { max-height: 90vh; }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { 'vazirmatn': ['Vazirmatn', 'sans-serif'] } } }
        }
    </script>
</head>
<body class="bg-[var(--bg-primary)] text-[var(--text-primary)]">

    <div id="toast">
        <span class="icon"></span>
        <span class="message"></span>
    </div>

    <!-- App promo modal: shown immediately on load and above everything -->
   
    
    <!-- Left: Countries list (Target-like) -->
    <div id="left">
        <div class="p-3 flex items-center justify-between gap-2">
            <button id="toggleListBtn" class="px-3 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] text-xs">
                <i class="fas fa-layer-group mr-1"></i>Filter by Category
            </button>
            <button id="favoritesTopBtn" onclick="selectFavorites()" class="px-3 py-2 rounded-lg neon-button border border-[var(--favorite-color)] text-[var(--favorite-color)] text-xs">
                <i class="fas fa-star mr-1"></i>Favorites
            </button>
            <button id="recordingsTopBtn" onclick="selectRecordings()" class="px-3 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] text-xs">
                <i class="fas fa-hdd mr-1"></i>Recordings
            </button>
        </div>
        <h3>üåç Select Countries</h3>
        <input type="text" id="countrySearch" placeholder="Search countries..." />
        <ul id="menu"></ul>
    </div>

    <!-- Right: Welcome + App content -->
    <div id="right">
        <div class="content-area">
            <div class="welcome-section" id="welcomeSection">
                <h2>Welcome to PlayTorrio IPTV</h2>
                <p>Select a country to explore channels from around the world</p>
                <div class="stats">
                    <div class="stat-item"><span class="stat-number">195+</span><span class="stat-label">Countries</span></div>
                    <div class="stat-item"><span class="stat-number">6000+</span><span class="stat-label">Channels</span></div>
                    <div class="stat-item"><span class="stat-number">HD</span><span class="stat-label">Quality</span></div>
                </div>
            </div>
        </div>
        <div id="appMain">
            <main class="container mx-auto p-4">
                <div id="search-filter-section" class="max-w-2xl mx-auto my-8 px-4" style="display:none;">
                    <div class="text-center mb-8">
                        <h2 id="main-title" class="text-xl font-bold mb-2">Channels</h2>
                        <p id="main-subtitle" class="text-[var(--text-secondary)] text-sm">Choose a category or country from the menu</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 space-y-6">
                        <div class="relative"><input type="text" id="channelSearch" class="w-full pl-4 pr-12 py-3 rounded-lg border focus:ring-2 focus:outline-none transition-all bg-[var(--bg-primary)] border-[var(--border-color)] text-[var(--text-primary)] text-sm" style="--tw-ring-color: var(--accent-primary);" placeholder="Type a channel name..."><i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]"></i></div>
                        <div class="flex flex-wrap gap-2 justify-center" id="sourceFilters">
                            <button onclick="toggleSourceFilter('all')" class="filter-btn active border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="all"><i class="fas fa-border-all mr-2"></i>All</button>
                            <button onclick="toggleSourceFilter('iptv')" class="filter-btn border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="iptv"><i class="fas fa-tv mr-2"></i>IPTV</button>
                            <button onclick="toggleSourceFilter('youtube')" class="filter-btn border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="youtube"><i class="fab fa-youtube mr-2"></i>YouTube</button>
                        </div>
                    </div>
                </div>
                
            <div id="resultsCount" class="text-center mb-6 hidden text-[var(--text-secondary)] text-sm"><span class="font-semibold text-[var(--text-primary)]" id="channelCount">0</span> items found</div>
                
                <div id="channelGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
                <div id="recordingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 hidden"></div>
                
            <div id="noResults" class="text-center py-12 hidden"><div class="mb-4 text-[var(--text-secondary)]"><i class="fas fa-search text-4xl"></i></div><h3 class="text-lg font-semibold mb-2">No results found</h3><p class="text-[var(--text-secondary)] text-sm" id="noResultsMessage">Please try a different search</p></div>
            </main>
        </div>
    </div>

    <div id="playerModal" class="hidden fixed inset-0 z-50" style="background-color: rgba(var(--bg-primary-rgb, 10, 10, 10), 0.9); backdrop-filter: blur(8px);">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl w-full max-w-4xl overflow-hidden modal-animation flex flex-col">
                <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)] flex-shrink-0">
                    <h2 id="channelTitle" class="text-lg font-bold truncate pr-4"></h2>
                    <button onclick="closePlayer()" class="w-8 h-8 flex items-center justify-center rounded-full transition-colors bg-[var(--bg-primary)] hover:bg-[var(--highlight-bg)]"><i class="fas fa-times"></i></button>
                </div>
                <div id="playerContainer" class="aspect-w-16 aspect-h-9 bg-black relative flex-grow"></div>
                <div class="p-3 flex flex-col gap-2 flex-shrink-0" style="background-color: rgba(var(--bg-primary-rgb, 10, 10, 10), 0.5);">
                    <!-- Main Controls -->
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="toggleIPTV" class="flex-1 px-4 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden text-sm"><i class="fas fa-tv mr-2"></i>IPTV</button>
                        <button id="toggleYouTube" class="flex-1 px-4 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden text-sm"><i class="fab fa-youtube mr-2"></i>YouTube</button>
                        <div class="flex-grow"></div>
                        <button id="pipBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="Picture-in-Picture"><i class="fas fa-clone"></i></button>
                        <button id="shareBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="Share"><i class="fas fa-share-alt"></i></button>
                        <button id="fullscreenBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="Fullscreen"><i class="fas fa-expand"></i></button>
                    </div>
                    <!-- Advanced Controls -->
                    <div class="flex flex-wrap items-center gap-2 border-t border-[var(--border-color)] pt-2">
                         <!-- Recording -->
                        <button id="recordBtn" class="flex-shrink-0 flex items-center justify-center neon-button border transition-all duration-300 hidden" title="Record video"><i class="fas fa-circle"></i></button>
                        <div id="recordControlsContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                            <select id="recordingQualitySelect" class="player-select" title="Recording quality">
                                <option value="source">Source quality</option>
                                <option value="high">High (2.5 Mbps)</option>
                                <option value="medium">Medium (1 Mbps)</option>
                                <option value="low">Low (500 kbps)</option>
                            </select>
                        </div>
                        <div class="flex-grow"></div>
                        <!-- Audio Only -->
                        <button id="audioOnlyBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="Audio only"><i class="fas fa-music"></i></button>
                        <!-- Playback Quality -->
                        <div id="qualityControlContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-sliders-h text-[var(--text-secondary)]"></i>
                            <select id="qualitySelect" class="player-select" title="Playback quality"></select>
                        </div>
                        <!-- Playback Speed -->
                        <div id="speedControlContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-gauge-high text-[var(--text-secondary)]"></i>
                            <select id="playbackSpeedSelect" class="player-select" title="Playback speed">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x (Normal)</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered'), err => console.error('SW registration failed: ', err));
            });
        }
        
        // --- PWA INSTALL PROMPT ---
        const menuInstallBtn = document.getElementById('menu-install-btn');
        const installContainer = document.getElementById('install-container');
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installContainer && menuInstallBtn) {
                installContainer.style.display = 'block';
                menuInstallBtn.disabled = false;
            }
        });

        if (menuInstallBtn) {
            menuInstallBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (installContainer) installContainer.style.display = 'none';
            });
        }

        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            if (installContainer) installContainer.style.display = 'none';
            showToast('App installed successfully!', 'success');
        });

        function setupInstallButton() {
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;
            if (installContainer && menuInstallBtn) {
                installContainer.style.display = 'block';
                menuInstallBtn.disabled = true;
            }
        }

        // --- THEME & COLOR ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const colorPicker = document.getElementById('color-picker');
        const themeCustomizer = document.getElementById('theme-customizer-container');
        const body = document.body;
        const THEME_COLORS = { cyan: '#00ffff', blue: '#0d6efd', purple: '#8442ff', pink: '#ff0073', green: '#00ff7f', orange: '#ffa500' };

        function applyTheme(theme) {
            body.classList.toggle('light-theme', theme === 'light');
            if (themeToggleBtn) themeToggleBtn.innerHTML = theme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            const isLight = theme === 'light';
            document.documentElement.style.setProperty('--bg-primary-rgb', isLight ? '248, 249, 250' : '10, 10, 10');
            document.documentElement.style.setProperty('--bg-secondary-rgb', isLight ? '255, 255, 255' : '26, 26, 26');

            if (themeCustomizer) themeCustomizer.style.display = isLight ? 'none' : 'block';
            if (isLight) {
                ['--accent-primary', '--shadow-color', '--highlight-bg', '--accent-primary-rgb'].forEach(prop => document.documentElement.style.removeProperty(prop));
            } else {
                applyAccentColor(localStorage.getItem('theme_color_name') || 'cyan');
            }
        }

        function applyAccentColor(colorName) {
            if (body.classList.contains('light-theme')) return;
            const colorValue = THEME_COLORS[colorName];
            const rgb = colorValue.match(/\w\w/g).map(x => parseInt(x, 16));
            document.documentElement.style.setProperty('--accent-primary', colorValue);
            document.documentElement.style.setProperty('--shadow-color', `rgba(${rgb.join(',')}, 0.3)`);
            document.documentElement.style.setProperty('--highlight-bg', `rgba(${rgb.join(',')}, 0.1)`);
            document.documentElement.style.setProperty('--accent-primary-rgb', rgb.join(','));
            localStorage.setItem('theme_color_name', colorName);
            updateColorSwatches(colorName);
        }
        
        function populateColorPicker() {
            if (!colorPicker) return;
            colorPicker.innerHTML = Object.entries(THEME_COLORS).map(([name, color]) => `
                <div class="color-swatch" style="background-color: ${color};" data-color="${name}" onclick="applyAccentColor('${name}')"></div>
            `).join('');
        }

        function updateColorSwatches(activeColorName) {
            if (!colorPicker) return;
            colorPicker.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.toggle('active', swatch.dataset.color === activeColorName);
            });
        }

        function loadSavedTheme() {
            applyTheme(localStorage.getItem('theme') || 'dark');
        }

        // --- APPLICATION LOGIC ---
        const COUNTRIES_METADATA_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/countries_metadata.json';
        const COUNTRY_BASE_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/countries/';
        const CATEGORIES_BASE_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/categories/';
        const FLAG_API_BASE = 'https://flagcdn.com/w80/';
        const FLAG_COUNTRY_MAPPINGS = { 'UK': 'gb', 'GB': 'gb' };
        
        const CATEGORIES = [
            {id:'animation',name_fa:'Animation',name_en:'Animation',icon:'fa-film'},
            {id:'auto',name_fa:'Auto',name_en:'Auto',icon:'fa-car'},
            {id:'business',name_fa:'Business',name_en:'Business',icon:'fa-briefcase'},
            {id:'classic',name_fa:'Classic',name_en:'Classic',icon:'fa-landmark'},
            {id:'comedy',name_fa:'Comedy',name_en:'Comedy',icon:'fa-masks-theater'},
            {id:'cooking',name_fa:'Cooking',name_en:'Cooking',icon:'fa-utensils'},
            {id:'culture',name_fa:'Culture',name_en:'Culture',icon:'fa-palette'},
            {id:'documentary',name_fa:'Documentary',name_en:'Documentary',icon:'fa-camera-retro'},
            {id:'education',name_fa:'Education',name_en:'Education',icon:'fa-graduation-cap'},
            {id:'entertainment',name_fa:'Entertainment',name_en:'Entertainment',icon:'fa-gamepad'},
            {id:'family',name_fa:'Family',name_en:'Family',icon:'fa-users'},
            {id:'general',name_fa:'General',name_en:'General',icon:'fa-tv'},
            {id:'history',name_fa:'History',name_en:'History',icon:'fa-scroll'},
            {id:'hobby',name_fa:'Hobby',name_en:'Hobby',icon:'fa-puzzle-piece'},
            {id:'kids',name_fa:'Kids',name_en:'Kids',icon:'fa-child-reaching'},
            {id:'legislative',name_fa:'Legislative',name_en:'Legislative',icon:'fa-gavel'},
            {id:'lifestyle',name_fa:'Lifestyle',name_en:'Lifestyle',icon:'fa-person-walking'},
            {id:'local',name_fa:'Local',name_en:'Local',icon:'fa-map-marker-alt'},
            {id:'movies',name_fa:'Movies',name_en:'Movies',icon:'fa-clapperboard'},
            {id:'music',name_fa:'Music',name_en:'Music',icon:'fa-music'},
            {id:'news',name_fa:'News',name_en:'News',icon:'fa-newspaper'},
            {id:'politics',name_fa:'Politics',name_en:'Politics',icon:'fa-landmark-dome'},
            {id:'religious',name_fa:'Religious',name_en:'Religious',icon:'fa-place-of-worship'},
            {id:'series',name_fa:'Series',name_en:'Series',icon:'fa-photo-film'},
            {id:'science',name_fa:'Science',name_en:'Science',icon:'fa-flask'},
            {id:'shop',name_fa:'Shop',name_en:'Shop',icon:'fa-shopping-cart'},
            {id:'sports',name_fa:'Sports',name_en:'Sports',icon:'fa-futbol'},
            {id:'travel',name_fa:'Travel',name_en:'Travel',icon:'fa-plane-departure'},
            {id:'weather',name_fa:'Weather',name_en:'Weather',icon:'fa-cloud-sun'}
        ];
    const COUNTRY_NAME_MAP_FA = {};
        
        // --- DOM Elements ---
        const channelGrid = document.getElementById('channelGrid');
        const recordingsGrid = document.getElementById('recordingsGrid');
        const playerModal = document.getElementById('playerModal');
        const channelTitle = document.getElementById('channelTitle');
        const playerContainer = document.getElementById('playerContainer');
        const toggleIPTVBtn = document.getElementById('toggleIPTV');
        const toggleYouTubeBtn = document.getElementById('toggleYouTube');
        const pipBtn = document.getElementById('pipBtn');
        const shareBtn = document.getElementById('shareBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const recordBtn = document.getElementById('recordBtn');
        const recordControlsContainer = document.getElementById('recordControlsContainer');
        const recordingQualitySelect = document.getElementById('recordingQualitySelect');
        const speedControlContainer = document.getElementById('speedControlContainer');
        const playbackSpeedSelect = document.getElementById('playbackSpeedSelect');
        const qualityControlContainer = document.getElementById('qualityControlContainer');
        const qualitySelect = document.getElementById('qualitySelect');
        const audioOnlyBtn = document.getElementById('audioOnlyBtn');
        
        // --- State Variables ---
        let currentChannelForModal = null;
        let currentPlayer = null, currentHls = null;
        let countriesData = null, currentChannels = [], allChannels = [];
        let favorites = [];
        let lastSelected = { type: 'country', id: 'IR' };
        
        // --- Recording State ---
        let db;
        let mediaRecorder;
        let recordedBlobs;
        let isRecording = false;
        let recordingTimerInterval;
        let recordingStartTime;

        // --- INITIALIZATION ---
        async function init() {
            setupInstallButton();
            populateColorPicker();
            loadSavedTheme();
            loadFavorites();
            await initDB();
            
            // Event Listeners
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = body.classList.contains('light-theme') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            }
            
            pipBtn.addEventListener('click', togglePiP);
            shareBtn.addEventListener('click', shareChannel);
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            recordBtn.addEventListener('click', toggleRecording);
            playbackSpeedSelect.addEventListener('change', setPlaybackSpeed);
            qualitySelect.addEventListener('change', setPlaybackQuality);
            audioOnlyBtn.addEventListener('click', toggleAudioOnly);


            // Show search changes
            document.getElementById('channelSearch').addEventListener('input', () => setTimeout(filterAndDisplay, 300));

            try {
                const response = await fetch(COUNTRIES_METADATA_URL);
                countriesData = await response.json();
                // Initialize left panel in countries mode so search placeholder is correct
                setLeftMode('countries');

                // Toggle between Countries and Categories list in the left pane
                const toggleBtn = document.getElementById('toggleListBtn');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        setLeftMode(leftMode === 'countries' ? 'categories' : 'countries');
                    });
                }

                // Unified click handler for left menu items (countries or categories)
                const menu = document.getElementById('menu');
                if (menu) {
                    menu.addEventListener('click', (e) => {
                        const li = e.target.closest('li[data-code], li[data-category]');
                        if (!li) return;
                        e.preventDefault();
                        if (li.dataset.code) {
                            const code = li.dataset.code;
                            selectCountry(code, countriesData[code]);
                        } else if (li.dataset.category) {
                            const catId = li.dataset.category;
                            const cat = CATEGORIES.find(c => c.id === catId);
                            if (cat) selectCategory(cat.id, cat.name_en, cat.icon);
                        }
                    });
                }

                // Search filter for left list (works for both modes)
                const countrySearch = document.getElementById('countrySearch');
                if (countrySearch) {
                    countrySearch.addEventListener('input', () => {
                        const term = countrySearch.value.toLowerCase();
                        const menuEl = document.getElementById('menu');
                        if (!menuEl) return;
                        [...menuEl.querySelectorAll('li')].forEach(li => {
                            const name = li.textContent.trim().toLowerCase();
                            li.style.display = name.includes(term) ? '' : 'none';
                        });
                    });
                }
                
                await checkForSharedChannel();

                // Preload all channels in background (optional for faster "All" view)
                await fetchAllChannels(countriesData);
            } catch (error) {
                console.error('Initialization failed:', error);
                
            }
        }
        
        // --- DATABASE (IndexedDB for Recordings) ---
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TVRecordingsDB', 1);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('recordings')) {
                        db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    resolve();
                };
                request.onerror = event => {
                    console.error('Database error:', event.target.error);
                    showToast('Error accessing the recordings database', 'error');
                    reject(event.target.error);
                };
            });
        }

        async function saveRecording(blob) {
            if (!db) return;
            const transaction = db.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            const recordingData = {
                channelName: currentChannelForModal?.name || 'Unknown Channel',
                timestamp: new Date(),
                videoBlob: blob
            };
            const request = store.add(recordingData);
            request.onsuccess = () => showToast(`"${recordingData.channelName}" recorded and saved`, 'success');
            request.onerror = (e) => {
                console.error('Could not save recording:', e.target.error);
                showToast('Failed to save video', 'error');
            };
        }

        async function getRecordings() {
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['recordings'], 'readonly');
                const store = transaction.objectStore('recordings');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        async function deleteRecording(id) {
            if (!db) return;
            const transaction = db.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            const request = store.delete(id);
            request.onsuccess = () => {
                showToast('Video deleted', 'success');
                selectRecordings(); // Refresh view
            };
             request.onerror = (e) => {
                console.error('Could not delete recording:', e.target.error);
                showToast('Failed to delete video', 'error');
            };
        }
        
        // --- RECORDING LOGIC ---
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!currentPlayer || !(currentPlayer instanceof HTMLVideoElement)) {
                showToast('Recording is only available for IPTV videos.', 'error');
                return;
            }
            const stream = currentPlayer.captureStream();
            if (!stream) {
                 showToast('Cannot capture the video stream for recording.', 'error');
                return;
            }
            
            recordedBlobs = [];
            const recorderOptions = { mimeType: 'video/webm; codecs=vp9' };
            const quality = recordingQualitySelect.value;
            switch(quality) {
                case 'high': recorderOptions.videoBitsPerSecond = 2500000; break;
                case 'medium': recorderOptions.videoBitsPerSecond = 1000000; break;
                case 'low': recorderOptions.videoBitsPerSecond = 500000; break;
            }

            try {
                mediaRecorder = new MediaRecorder(stream, recorderOptions);
            } catch (e) {
                console.error('MediaRecorder error:', e);
                try {
                     mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                } catch (e2) {
                    showToast("Your browser doesn't support the recording format.", 'error');
                    return;
                }
            }

            isRecording = true;
            recordBtn.classList.add('recording');
            recordBtn.title = 'Stop recording';

            recordingStartTime = Date.now();
            updateRecordingTimer();
            recordingTimerInterval = setInterval(updateRecordingTimer, 1000);

            mediaRecorder.onstop = (event) => {
                const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                saveRecording(superBuffer);
            };
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    recordedBlobs.push(event.data);
                }
            };
            
            mediaRecorder.start(10);
            showToast('Recording started...', 'success');
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;

            clearInterval(recordingTimerInterval);
            recordBtn.innerHTML = '<i class="fas fa-circle"></i>';
            recordBtn.classList.remove('recording');
            recordBtn.title = 'Record video';
        }

        function updateRecordingTimer() {
            if (!isRecording) return;
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor((elapsed / 1000) % 60);
            const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            recordBtn.textContent = formattedTime;
        }


        // --- UI & DISPLAY ---
        function getChannelId(channel) { return `${channel.country || 'cat'}_${channel.name.replace(/[^a-zA-Z0-9]/g, '')}`; }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = 'show';
            toast.classList.add(type);
            toast.querySelector('.message').textContent = message;
            toast.querySelector('.icon').innerHTML = type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>';
            setTimeout(() => { toast.className = ''; }, 3000);
        }
        
        function showLoading(isChannels = true) {
            const grid = isChannels ? channelGrid : recordingsGrid;
            let skeletonHTML = '';
            for (let i = 0; i < 18; i++) {
                skeletonHTML += `
                    <div class="skeleton-card rounded-xl h-28 p-4 flex flex-col justify-between">
                        <div class="h-4 bg-[var(--border-color)] rounded w-3/4"></div>
                        <div class="flex justify-between items-center">
                            <div class="h-6 w-6 bg-[var(--border-color)] rounded-full"></div>
                            <div class="h-4 bg-[var(--border-color)] rounded w-1/4"></div>
                        </div>
                    </div>`;
            }
            grid.innerHTML = skeletonHTML;
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('resultsCount').classList.add('hidden');
        }
        
        function switchView(viewName) {
            channelGrid.classList.toggle('hidden', viewName !== 'channels');
            recordingsGrid.classList.toggle('hidden', viewName !== 'recordings');
            document.getElementById('search-filter-section').style.display = (viewName === 'recordings' ? 'none' : 'block');
        }
        
        function displayChannels(channels) {
            switchView('channels');
            if (channels.length === 0) {
                channelGrid.innerHTML = '';
                document.getElementById('noResultsMessage').textContent = 'Try a different search or change filters.';
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');

            channelGrid.innerHTML = channels.map(channel => {
                const channelId = getChannelId(channel);
                const isFavorite = favorites.some(fav => getChannelId(fav) === channelId);
                return `
                <div class="channel-card glass-effect rounded-xl overflow-hidden p-4 flex flex-col justify-center items-center text-center h-28 cursor-pointer" onclick='playChannel(${JSON.stringify(channel).replace(/'/g, "\\'")})'>
                    <i class="favorite-star ${isFavorite ? 'fa-solid favorited' : 'fa-regular'} fa-star" data-channel-id="${channelId}" onclick="toggleFavorite(event, this)"></i>
                    <div class="flex-grow flex flex-col justify-center items-center">
                        <h3 class="font-semibold text-xs mb-2 text-[var(--text-primary)]">${channel.name}</h3>
                        ${channel.country ? `<img src="${FLAG_API_BASE}${FLAG_COUNTRY_MAPPINGS[channel.country.toUpperCase()] || channel.country.toLowerCase()}.png" alt="${channel.country}" class="w-6 h-4 object-cover rounded shadow-md border border-white/20 mb-2" onerror="this.style.display='none'">` : ''}
                    </div>
                    <div class="flex gap-2 text-xs justify-center">
                        ${channel.iptv_urls.length ? `<span class="px-2 py-1 rounded-full text-xs" style="background-color: var(--highlight-bg); color: var(--accent-primary);"><i class="fas fa-tv ml-1"></i>IPTV</span>` : ''}
                        ${channel.youtube_urls.length ? `<span class="px-2 py-1 rounded-full text-xs" style="background-color: rgba(var(--accent-secondary-rgb), 0.2); color: var(--accent-secondary);"><i class="fab fa-youtube ml-1"></i>YouTube</span>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function displayRecordings(recordings) {
            switchView('recordings');
            document.getElementById('resultsCount').classList.toggle('hidden', recordings.length === 0);
            document.getElementById('channelCount').textContent = recordings.length;
            
            if (recordings.length === 0) {
                recordingsGrid.innerHTML = '';
                document.getElementById('noResultsMessage').textContent = "You haven't recorded any videos yet.";
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');
            
            recordingsGrid.innerHTML = recordings.sort((a,b) => b.timestamp - a.timestamp).map(rec => {
                const videoUrl = URL.createObjectURL(rec.videoBlob);
                return `
                <div class="recording-card glass-effect rounded-xl overflow-hidden p-4 flex flex-col justify-between">
                    <div>
                        <h3 class="font-semibold text-sm mb-2 text-[var(--text-primary)]">${rec.channelName}</h3>
                        <p class="text-xs text-[var(--text-secondary)] mb-3">${new Date(rec.timestamp).toLocaleString('en-US')}</p>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="playRecording('${videoUrl}', '${rec.channelName}')" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)]"><i class="fas fa-play"></i></button>
                        <a href="${videoUrl}" download="${rec.channelName}_${new Date(rec.timestamp).toISOString()}.webm" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)]"><i class="fas fa-download"></i></a>
                        <button onclick="deleteRecording(${rec.id})" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border" style="border-color:var(--record-color); color:var(--record-color);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleFavorite(event, starIcon) {
            event.stopPropagation(); 
            const channelId = starIcon.dataset.channelId;
            const favIndex = favorites.findIndex(fav => getChannelId(fav) === channelId);
            
            if (favIndex > -1) { 
                favorites.splice(favIndex, 1);
                starIcon.classList.remove('fa-solid', 'favorited');
                starIcon.classList.add('fa-regular');
                showToast('Removed from favorites', 'error');
            } else { 
                const masterList = ['all', 'favorites'].includes(lastSelected.type) ? allChannels : currentChannels;
                const channel = masterList.find(ch => getChannelId(ch) === channelId);
                if (channel) {
                    favorites.push(channel);
                    starIcon.classList.add('fa-solid', 'favorited');
                    starIcon.classList.remove('fa-regular');
                    showToast('Added to favorites', 'success');
                }
            }
            saveFavorites();
            if (lastSelected.type === 'favorites') filterAndDisplay();
        }
        
        // --- PLAYER LOGIC ---
        function playChannel(channel) {
            currentChannelForModal = channel;
            playerModal.classList.remove('hidden');
            channelTitle.textContent = channel.name;
            const hasIptv = channel.iptv_urls?.length > 0;
            const hasYoutube = channel.youtube_urls?.length > 0;
            
            toggleIPTVBtn.classList.toggle('hidden', !hasIptv);
            toggleYouTubeBtn.classList.toggle('hidden', !hasYoutube);
            shareBtn.classList.remove('hidden');
            fullscreenBtn.classList.remove('hidden');
            
            [recordBtn, recordControlsContainer, speedControlContainer, qualityControlContainer, audioOnlyBtn].forEach(el => el.classList.add('hidden'));

            if (hasIptv) toggleIPTVBtn.onclick = () => setupIPTVPlayer(channel.iptv_urls[0]);
            if (hasYoutube) toggleYouTubeBtn.onclick = () => setupYouTubePlayer(channel.youtube_urls[0]);
            
            if (playerContainer.innerHTML !== '') playerContainer.innerHTML = '';
            hasIptv ? setupIPTVPlayer(channel.iptv_urls[0]) : hasYoutube ? setupYouTubePlayer(channel.youtube_urls[0]) : null;
        }
        
        function playRecording(url, title) {
            playerModal.classList.remove('hidden');
            channelTitle.textContent = "Recording: " + title;
            
            [toggleIPTVBtn, toggleYouTubeBtn, pipBtn, shareBtn, recordBtn, recordControlsContainer, qualityControlContainer, audioOnlyBtn].forEach(btn => btn.classList.add('hidden'));
            fullscreenBtn.classList.remove('hidden');
            speedControlContainer.classList.remove('hidden');

            playerContainer.innerHTML = `<video controls autoplay class="w-full h-full" src="${url}"></video>`;
            currentPlayer = playerContainer.querySelector('video');
            currentPlayer.oncanplay = () => {
                playbackSpeedSelect.value = 1;
                currentPlayer.playbackRate = 1;
            };
        }

        function setupIPTVPlayer(url) {
            if (currentHls) currentHls.destroy();
            playerContainer.innerHTML = `<video controls autoplay class="w-full h-full relative z-10"></video>`;
            const video = playerContainer.querySelector('video');
            currentPlayer = video;
            
            [pipBtn, recordBtn, recordControlsContainer, speedControlContainer, audioOnlyBtn].forEach(el => el.classList.remove('hidden'));
            
            playbackSpeedSelect.value = 1;
            video.playbackRate = 1;
            qualityControlContainer.classList.add('hidden');
            qualitySelect.innerHTML = '';
            recordingQualitySelect.value = 'source';
            
            // MODIFIED: Reset audio only button state
            playerContainer.classList.remove('audio-mode');
            audioOnlyBtn.classList.remove('active');
            audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
            audioOnlyBtn.title = 'Audio only';


            if (Hls.isSupported()) {
                currentHls = new Hls();
                currentHls.loadSource(url);
                currentHls.attachMedia(video);

                currentHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                    if (data.levels.length > 1) {
                        qualitySelect.innerHTML = '<option value="-1">Auto</option>' + 
                            data.levels.map((level, index) => `<option value="${index}">${level.height}p</option>`).join('');
                        qualitySelect.value = currentHls.currentLevel;
                        qualityControlContainer.classList.remove('hidden');
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            }
            toggleIPTVBtn.style.opacity = '1'; toggleYouTubeBtn.style.opacity = '0.5';
        }

        function setupYouTubePlayer(url) {
            if (currentHls) currentHls.destroy();
            currentPlayer = null;
            
            [pipBtn, recordBtn, recordControlsContainer, speedControlContainer, qualityControlContainer, audioOnlyBtn].forEach(el => el.classList.add('hidden'));

            const videoId = new URL(url).searchParams.get('v');
            playerContainer.innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
            toggleYouTubeBtn.style.opacity = '1'; toggleIPTVBtn.style.opacity = '0.5';
        }

        function closePlayer() {
            if (isRecording) stopRecording();
            playerModal.classList.add('hidden');
            if (currentHls) currentHls.destroy();
            playerContainer.innerHTML = '';
            currentPlayer = null;
            currentChannelForModal = null;
            
            // MODIFIED: Reset audio only button state on close
            playerContainer.classList.remove('audio-mode');
            audioOnlyBtn.classList.remove('active');
            audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
            audioOnlyBtn.title = 'Audio only';

            if (document.pictureInPictureElement) document.exitPictureInPicture();
            if (document.fullscreenElement) document.exitFullscreen();
        }
        
        async function togglePiP() {
            if (!currentPlayer) return;
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await currentPlayer.requestPictureInPicture();
                }
            } catch (error) { showToast('Failed to toggle Picture-in-Picture', 'error'); }
        }
        
        function setPlaybackSpeed(event) {
            if (currentPlayer) {
                currentPlayer.playbackRate = parseFloat(event.target.value);
            }
        }
        function setPlaybackQuality(event) {
            if (currentHls) {
                currentHls.currentLevel = parseInt(event.target.value, 10);
            }
        }
        
        // MODIFIED: Toggle audio only with icon and title change
        function toggleAudioOnly() {
            const isActive = playerContainer.classList.toggle('audio-mode');
            audioOnlyBtn.classList.toggle('active', isActive);
            if (isActive) {
                audioOnlyBtn.innerHTML = '<i class="fas fa-video"></i>';
                audioOnlyBtn.title = 'Show video';
            } else {
                audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
                audioOnlyBtn.title = 'Audio only';
            }
        }

        function shareChannel() {
            if (!currentChannelForModal) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?channel=${getChannelId(currentChannelForModal)}`;
            navigator.clipboard.writeText(shareUrl).then(() => showToast('Channel link copied!', 'success'), () => showToast('Failed to copy link', 'error'));
        }
        
        async function checkForSharedChannel() {
            const channelId = new URLSearchParams(window.location.search).get('channel');
            if (!channelId) return;
            await fetchAllChannels(countriesData, true); 
            const sharedChannel = allChannels.find(ch => getChannelId(ch) === channelId);
            if (sharedChannel) {
                playChannel(sharedChannel);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function fetchAllChannels(countries, forceWait = false) {
            if (allChannels.length > 0 && !forceWait) return;
            const allBtn = document.getElementById('allChannelsBtn');
            if (allBtn) allBtn.disabled = true;
            const promises = Object.keys(countries)
                .filter(code => countries[code].hasChannels)
                .map(code => fetch(`${COUNTRY_BASE_URL}${code.toLowerCase()}.json`).then(res => res.ok ? res.json() : []).catch(() => []));
            allChannels = (await Promise.all(promises)).flat();
            if (allBtn) allBtn.disabled = false;
        }
        
        // --- UTILITY & HELPER FUNCTIONS ---
        function toggleAccordion(type) {
            const btn = document.getElementById(`${type}AccordionBtn`);
            const content = document.getElementById(`${type}AccordionContent`);
            content.classList.toggle('hidden');
            btn.querySelector('i.fa-chevron-down').classList.toggle('rotate-180');
        }
        function loadFavorites() { favorites = JSON.parse(localStorage.getItem('tvFavorites') || '[]'); }
        function saveFavorites() { localStorage.setItem('tvFavorites', JSON.stringify(favorites)); }
        
    function selectFavorites() { lastSelected = {type:'favorites'}; const welcome=document.getElementById('welcomeSection'); if (welcome) welcome.style.display='none'; const searchSec=document.getElementById('search-filter-section'); if (searchSec) searchSec.style.display='block'; document.getElementById('main-title').innerHTML = `<i class="fas fa-star mr-2" style="color: var(--favorite-color);"></i>Favorites`; document.getElementById('main-subtitle').textContent = `Channels you've starred`; filterAndDisplay(); }
    async function selectRecordings() { lastSelected = {type:'recordings'}; const welcome=document.getElementById('welcomeSection'); if (welcome) welcome.style.display='none'; document.getElementById('main-title').innerHTML = `<i class="fas fa-hdd mr-2"></i>Recordings`; document.getElementById('main-subtitle').textContent = `Videos you have recorded and saved`; const recs = await getRecordings(); displayRecordings(recs); }
    function selectAllWindows() { lastSelected = {type:'all'}; document.getElementById('welcomeSection').style.display='none'; document.getElementById('search-filter-section').style.display='block'; document.getElementById('main-title').innerHTML = `<i class="fas fa-globe-europe mr-2"></i>All Channels`; document.getElementById('main-subtitle').textContent = `Showing all available channels`; currentChannels = allChannels; filterAndDisplay(); }
    function selectCountry(code, data) { lastSelected = {type:'country', id:code}; document.getElementById('welcomeSection').style.display='none'; document.getElementById('search-filter-section').style.display='block'; document.getElementById('main-title').textContent = `Channels of ${data.country}`; document.getElementById('main-subtitle').innerHTML = `Live TV channels from <img src="${FLAG_API_BASE}${FLAG_COUNTRY_MAPPINGS[code.toUpperCase()] || code.toLowerCase()}.png" class="w-5 h-4 inline-block mx-1 rounded-sm"> ${data.country}`; loadChannels(`${COUNTRY_BASE_URL}${code.toLowerCase()}.json`); }
    function selectCategory(id, name, icon) { lastSelected = {type:'category', id:id}; document.getElementById('welcomeSection').style.display='none'; document.getElementById('search-filter-section').style.display='block'; document.getElementById('main-title').innerHTML = `<i class="fas ${icon} mr-2"></i>Category: ${name}`; document.getElementById('main-subtitle').textContent = `Channels related to ${name}`; loadChannels(`${CATEGORIES_BASE_URL}${id}.json`); }
        
    function isMobileViewport() { try { return window.matchMedia && window.matchMedia('(max-width: 768px)').matches; } catch (_) { return (window.innerWidth || 1024) <= 768; } }
    function maybeScrollToResults() {
        if (!isMobileViewport()) return;
        const grid = document.getElementById('channelGrid');
        const searchHeader = document.getElementById('search-filter-section');
        const target = (grid && grid.offsetParent !== null) ? grid : searchHeader;
        if (!target) return;
        // Delay slightly to ensure DOM updated with results
        setTimeout(() => { try { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) { window.scrollTo({ top: target.getBoundingClientRect().top + window.pageYOffset - 10, behavior: 'smooth' }); } }, 60);
    }
    async function loadChannels(url) { showLoading(); try { const res = await fetch(url); currentChannels = await res.json(); filterAndDisplay(); maybeScrollToResults(); } catch (e) { showError('Failed to load channels.'); } }
        
        function filterAndDisplay() {
            if (lastSelected.type === 'recordings') return;
            let source = [];
            if (lastSelected.type === 'favorites') source = favorites;
            else if (lastSelected.type === 'all') source = allChannels;
            else source = currentChannels;
            
            const searchTerm = document.getElementById('channelSearch').value.toLowerCase();
            const activeSourceFilter = document.querySelector('#sourceFilters .filter-btn.active').dataset.filter;
            
            const filtered = source.filter(ch => 
                ch.name.toLowerCase().includes(searchTerm) && 
                (activeSourceFilter === 'all' || 
                (activeSourceFilter === 'iptv' && ch.iptv_urls.length) || 
                (activeSourceFilter === 'youtube' && ch.youtube_urls.length))
            );
            
            displayChannels(filtered);
            document.getElementById('channelCount').textContent = filtered.length;
            document.getElementById('resultsCount').classList.toggle('hidden', filtered.length === 0);
        }
        
        function toggleSourceFilter(filter) { document.querySelectorAll('#sourceFilters .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter)); filterAndDisplay(); }
        
        // Left panel toggle between countries and categories
        let leftMode = 'countries';

        function renderCategoriesMenu() {
            const menu = document.getElementById('menu');
            if (!menu) return;
            menu.innerHTML = CATEGORIES.map(c => `
                <li data-category="${c.id}">
                    <a href="#">
                        <p><i class="fas ${c.icon} mr-2"></i>${c.name_en}</p>
                    </a>
                </li>
            `).join('');
        }
        
        // Render left countries menu (Target-like)
        function renderCountriesMenu(data) {
            const menu = document.getElementById('menu');
            if (!menu) return;
            const countries = Object.entries(data)
                .filter(([_, d]) => d.hasChannels)
                .sort((a, b) => a[1].country.localeCompare(b[1].country, 'en'));
            menu.innerHTML = countries.map(([code, d]) => `
                <li data-code="${code}"><a href="#"><p>${d.country}</p></a></li>
            `).join('');
        }

        function setLeftMode(mode) {
            leftMode = mode;
            const header = document.querySelector('#left h3');
            const toggleBtn = document.getElementById('toggleListBtn');
            const search = document.getElementById('countrySearch');
            if (mode === 'countries') {
                if (header) header.innerHTML = 'üåç Select Countries';
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>Filter by Category';
                renderCountriesMenu(countriesData);
                if (search) search.placeholder = 'Search countries...';
            } else {
                if (header) header.innerHTML = 'üìÇ Select Category';
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-flag mr-1"></i>Filter by Country';
                renderCategoriesMenu();
                if (search) search.placeholder = 'Search categories...';
            }
            if (search) {
                search.value = '';
                // Trigger filtering to reset visibility
                const menu = document.getElementById('menu');
                if (menu) {
                    [...menu.querySelectorAll('li')].forEach(li => li.style.display = '');
                }
            }
        }
        
        function showError(message) { channelGrid.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p>${message}</p></div>`; }
        function toggleFullScreen() { 
            const elem = currentPlayer || playerContainer; 
            if (!document.fullscreenElement && !document.webkitFullscreenElement) { 
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.error(err)); 
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
            } else { 
                if (document.exitFullscreen) {
                    document.exitFullscreen(); 
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            } 
        }

        // App promo helpers
        function closeAppPromo() {
            const modal = document.getElementById('appPromoModal');
            if (modal) modal.remove();
        }

        // ESC to close promo first, then player
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const promo = document.getElementById('appPromoModal');
                if (promo) { closeAppPromo(); return; }
                if (!playerModal.classList.contains('hidden')) { closePlayer(); }
            }
        });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
